<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="generator" content="Colloquy 2.0" />
	<meta name="formatter" content="libxslt 1.1.0" />
	<title>%@</title>
	<script type="text/ecmascript" defer="defer">
		var scrollToBottomIsNeeded = false;
		var scrollBackLimit = 500;

		function prependMessages( html ) {
			checkIfScrollToBottomIsNeeded();

			bodyNode = document.getElementsByTagName( "body" ).item( 0 );
			range = document.createRange();
			range.selectNode( bodyNode );
			documentFragment = range.createContextualFragment( html );
			if( bodyNode.children.length ) document.body.insertBefore( documentFragment, bodyNode.children[0] );
			else bodyNode.appendChild( documentFragment );

			scrollToBottomIfNeeded();
		}

		function appendMessage( html ) {
			checkIfScrollToBottomIsNeeded();
			removeConsecutiveInsertPoint();

			bodyNode = document.getElementsByTagName( "body" ).item( 0 );
			range = document.createRange();
			range.selectNode( bodyNode );
			documentFragment = range.createContextualFragment( html );
			bodyNode.appendChild( documentFragment );

			enforceScrollBackLimit();
			scrollToBottomIfNeeded();
		}

		function appendConsecutiveMessage( html ) {
			checkIfScrollToBottomIsNeeded();

			insert = document.getElementById( "consecutiveInsert" );
			if( ! insert ) {
				appendMessage( html );
				return;
			}

			range = document.createRange();
			range.selectNode( insert.parentNode );
			documentFragment = range.createContextualFragment( html );
			insert.parentNode.replaceChild( documentFragment, insert );

			enforceScrollBackLimit();
			scrollToBottomIfNeeded();
		}

		function removeConsecutiveInsertPoint() {
			insert = document.getElementById( "consecutiveInsert" );
			if( insert ) insert.parentNode.removeChild( insert );
		}

		function scrollBackMessageCount() {
			bodyNode = document.getElementsByTagName( "body" ).item( 0 );
			return bodyNode.children.length;
		}

		function enforceScrollBackLimit() {
			bodyNode = document.getElementsByTagName( "body" ).item( 0 );
			if( scrollBackLimit > 0 && bodyNode.children.length > scrollBackLimit )
				for( i = 0; bodyNode.children.length > scrollBackLimit && i < ( bodyNode.children.length - scrollBackLimit ); i++ )
					bodyNode.removeChild( bodyNode.children[0] );
		}

		function messageIsInScrollback( id ) {
			return ( document.getElementById( id ).id.length ? 1 : 0 );
		}

		function locationOfMessage( id ) {
			element = document.getElementById( id );
			return element.offsetTop;
		}

		function locationOfElementAtIndex( index ) {
			bodyNode = document.getElementsByTagName( "body" ).item( 0 );
			return bodyNode.children[index].offsetTop;
		}

		function scrollToBottom() {
			document.body.scrollTop = document.body.offsetHeight;
		}

		function checkIfScrollToBottomIsNeeded() {
			scrollToBottomIsNeeded = ( document.body.scrollTop >= ( document.body.offsetHeight - ( window.innerHeight * 1.1 ) ) );
		}

		function scrollToBottomIfNeeded() {
			if( scrollToBottomIsNeeded )
				scrollToBottom();
		}

		function setStylesheet( id, url ) {
			code = "<style id=\"" + id + "\" type=\"text/css\" media=\"screen,print\">";
			if( url.length ) code += "@import url( \"" + url + "\" );";
			code += "</style>";
			range = document.createRange();
			head = document.getElementsByTagName( "head" ).item(0);
			range.selectNode( head );
			documentFragment = range.createContextualFragment( code );
			head.removeChild( document.getElementById( id ) );
			head.appendChild( documentFragment );
		}
		
		function showTopic( topic ) {
			hideTopic(); // just in case
			div = document.createElement( "div" );
			div.style.position = "fixed";
			div.style.left = "16px";
			div.style.right = "16px";
			div.style.top = "8px";
			div.style["background-color"] = "rgba(255, 255, 90, 0.84)";
			div.style.color = "black";
			div.style.border = "1px solid black";
			div.style.padding = "5px";
			div.style["padding-right"] = "16px";
			div.style["font-family"] = "Lucida Grande";
			div.style["font-size"] = "11px";
			div.id = "topic-floater";
			button = document.createElement( "div" );
			button.style.position = "absolute";
			button.style.top = "2px";
			button.style.right = "2px";
			button.style["font-size"] = "10px";
			button.style.width = "12px";
			button.style.height = button.style.width;
			button.style.color = "#999999";
			button.style["background-color" ] = "#DDDDDD";
			button.style.border = "1px solid " + button.style.color;
			button.style.margin = "0";
			button.style.padding = "0";
			button.style["text-align"] = "center";
			//
			button.style.cursor = "pointer";
			button.setAttribute( "onclick", "hideTopic(); return false;" );
			/*link = document.createElement( "a" );
			link.style.color = "inherit";
			link.style["text-decoration"] = "inherit";
			link.setAttribute( "href", "#" );
			link.setAttribute( "onclick", "hideTopic(); return false;" );*/
			text = document.createTextNode( "X" );
			/*link.appendChild( text );
			button.appendChild( link );*/
			button.appendChild( text );
			div.appendChild( button );
			body = document.getElementsByTagName( "body" ).item(0);
			range = document.createRange();
			range.selectNode( body );
			documentFragment = range.createContextualFragment( topic );
			div.appendChild( documentFragment );
			body.appendChild(div);
		}
		
		function hideTopic( topic ) {
			div = document.getElementById("topic-floater");
			if( div )
				div.parentNode.removeChild(div);
		}
	</script>
	<style id="emoticonStyle" type="text/css" media="screen,print">@import url( "%@" );</style>
	<style id="mainStyle" type="text/css" media="screen,print">@import url( "%@" );</style>
	<style id="variantStyle" type="text/css" media="screen,print">@import url( "%@" );</style>
	<base href="%@" />
</head>
<body onload="scrollToBottom()">
%@
%@
</body>
</html>