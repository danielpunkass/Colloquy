<script type="text/ecmascript" defer="defer">
  var scrollBackLimit = 250;

  function enforceScrollbackLimit() {
    var bodyNode = document.getElementsByTagName('body').item( 0 );

    // Quick removal of divs of any kind.
    var messages = document.getElementsByTagName('div');

    // Careful removal of only message and event divs.
    //var messages = [];
    //var divNodes = document.getElementsByTagName('div');
    //for (var i=0; i<divNodes.length; i++) {
    //    currNode = divNodes[i];
    //    if ( (currNode.className.indexOf('envelope') != -1) ||
    //         (currNode.className.indexOf('event') != -1) )
    //        messages[messages.length] = currNode;
    //}

    if (messages.length > scrollBackLimit)
      for (var i=0; i < (messages.length - scrollBackLimit); i++)
        bodyNode.removeChild(messages[i])
  }

      function appendMessage( html ) {
			checkIfScrollToBottomIsNeeded();
			removeConsecutiveInsertPoint();

			range = document.createRange();
			range.selectNode( document.getElementsByTagName( "body" ).item( 0 ) );
			documentFragment = range.createContextualFragment( html );
			document.body.appendChild( documentFragment );

            enforceScrollbackLimit();
      
			scrollToBottomIfNeeded();
		}

		function appendConsecutiveMessage( html ) {
			checkIfScrollToBottomIsNeeded();

			insert = document.getElementById( "consecutiveInsert" );
			if( ! insert ) {
				appendMessage( html );
				return;
			}

			range = document.createRange();
			range.selectNode( insert.parentNode );
			documentFragment = range.createContextualFragment( html );
			insert.parentNode.replaceChild( documentFragment, insert );

            enforceScrollbackLimit();
      
			scrollToBottomIfNeeded();
		}

</script>
